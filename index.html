<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width">
<title>Visitor Log</title>
<style>
body { font-family: sans-serif; padding: 20px; }
.hidden { display: none; }
button { padding: 15px; margin: 10px; font-size: 18px; }
</style>
</head>
<body>

<div id="login">
  <h2>Enter Passcode</h2>
  <input type="password" id="code">
  <button onclick="login()">Enter</button>
</div>

<div id="site" class="hidden">
  <h2>Select Site</h2>
  <button onclick="selectSite('Site A')">Site A</button>
  <button onclick="selectSite('Site B')">Site B</button>
  <button onclick="selectSite('Site C')">Site C</button>
</div>

<div id="app" class="hidden">
  <h2 id="siteTitle"></h2>
  <button onclick="showTab('scan')">Scan</button>
  <button onclick="showTab('onsite')">On Site</button>

  <div id="scan">
    <button onclick="manual()">Manual Entry</button>
    <div id="form" class="hidden">
      <input placeholder="Driver" id="driver"><br>
      <input placeholder="Truck" id="truck"><br>
      <button onclick="checkin()">Check In</button>
    </div>
  </div>

  <div id="onsite" class="hidden"></div>
</div>

<script>
const GUARD = "KpsGuard15857!";
const ADMIN = "Kps17701";
const API = "https://script.google.com/macros/s/AKfycby52PhybpixBnv3wjCCjG1wuWr9E_ziMdYQs9zeSRuzoMp9J5LrFdi9IRWcEoGLYm3Z/exec";

let role = "", site = "";

function login() {
  const c = code.value;
  if (c === GUARD) role = "guard";
  if (c === ADMIN) role = "admin";
  if (!role) return alert("Invalid code");
  document.getElementById("login").classList.add("hidden");
  document.getElementById("site").classList.remove("hidden");
}

function selectSite(s) {
  site = s;
  document.getElementById("site").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  document.getElementById("siteTitle").innerText = s;
}

function showTab(t) {
  document.getElementById("scan").classList.toggle("hidden", t !== "scan");
  document.getElementById("onsite").classList.toggle("hidden", t !== "onsite");
  if (t === "onsite") loadOnSite();
}

function manual() {
  document.getElementById("form").classList.remove("hidden");
}

function checkin() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "checkin",
      site,
      driver: driver.value,
      truck: truck.value
    })
  });
  driver.value = truck.value = "";
  alert("Checked In");
}

function loadOnSite() {
  fetch(API + "?site=" + encodeURIComponent(site))
    .then(r => r.json())
    .then(rows => {
      const div = document.getElementById("onsite");
      div.innerHTML = "";
      rows.slice(1).filter(r => r[4] === "On Site").forEach(r => {
        const b = document.createElement("button");
        b.textContent = r[2] + " (" + r[3] + ")";
        b.onclick = () => checkout(r[2]);
        div.appendChild(b);
      });
    });
}

function checkout(driver) {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "checkout", site, driver })
  });
  loadOnSite();
}
</script>
</body>
</html>

