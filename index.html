<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visitor Check-In v5</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background-color: #0A2E5D; color: white; display: flex; flex-direction: column; height: 100vh; }
  .centered { display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; }
  .button { padding: 15px 30px; margin: 10px; font-size: 18px; cursor: pointer; border: none; border-radius: 8px; }
  .button-primary { background-color: #1E70BF; color: white; }
  .button-secondary { background-color: #3E8ED0; color: white; }
  .button-danger { background-color: #D9534F; color: white; }
  input { padding: 10px; font-size: 16px; border-radius: 5px; border: none; margin: 5px 0; }
  .tab-bar { display: flex; justify-content: space-around; background: #0D3B70; padding: 10px 0; }
  .tab-bar button { flex: 1; }
  .card { background: #154680; padding: 15px; margin: 10px; border-radius: 10px; }
  #cameraContainer { position: relative; width: 100%; max-width: 400px; height: 300px; margin: 20px auto; }
  #cameraContainer video { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; }
  #cancelCamera { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: #D9534F; color: white; border: none; border-radius: 8px; cursor: pointer; z-index: 10; }
</style>
</head>
<body>
<div id="versionBanner" style="text-align:center;background:#154680;padding:5px;">APP VERSION: v5</div>

<div id="passcodeScreen" class="centered">
  <h2>Enter Passcode</h2>
  <input type="password" id="passcodeInput" placeholder="Passcode">
  <button class="button button-primary" id="enterPasscodeBtn">Enter</button>
</div>

<div id="siteSelectionScreen" class="centered" style="display:none;">
  <h2>Select Site</h2>
  <button class="button button-primary siteBtn" data-site="Site A">Site A</button>
  <button class="button button-primary siteBtn" data-site="Site B">Site B</button>
  <button class="button button-primary siteBtn" data-site="Site C">Site C</button>
</div>

<div id="appScreen" style="display:none; flex:1; flex-direction:column;">
  <div id="tabs" class="tab-bar">
    <button id="scanTabBtn" class="button button-primary">Scan</button>
    <button id="onSiteTabBtn" class="button button-primary">On Site</button>
  </div>

  <div id="scanTab" class="centered">
    <button class="button button-primary" id="scanBtn">üì∑ Scan</button>
    <button class="button button-secondary" id="manualBtn">‚úèÔ∏è Manual Entry</button>
    <div id="cameraContainer" style="display:none;">
      <video id="cameraVideo" autoplay></video>
      <button id="cancelCamera">Cancel</button>
    </div>
  </div>

  <div id="onSiteTab" class="centered" style="display:none; overflow-y:auto; flex:1; width:100%;">
    <input type="text" id="searchInput" placeholder="Search name or truck">
    <div id="onSiteList" style="width:100%;"></div>
    <button class="button button-primary" id="refreshOnSiteBtn">Refresh</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxtXiu1A9JKFx8KEpngA0Dnp1_MfrIDH0jpkrILHTt6CD73w8mKP7g36oi4wS4J1eK8/exec";
const PASSCODE = "test";

let currentSite = "";

document.getElementById("enterPasscodeBtn").onclick = () => {
  const val = document.getElementById("passcodeInput").value;
  if(val === PASSCODE){
    document.getElementById("passcodeScreen").style.display = "none";
    document.getElementById("siteSelectionScreen").style.display = "flex";
  } else {
    alert("Wrong passcode");
  }
};

document.querySelectorAll(".siteBtn").forEach(btn => {
  btn.onclick = () => {
    currentSite = btn.dataset.site;
    document.getElementById("siteSelectionScreen").style.display = "none";
    document.getElementById("appScreen").style.display = "flex";
    showScanTab();
    refreshOnSiteList();
  };
});

function showScanTab() {
  document.getElementById("scanTab").style.display = "flex";
  document.getElementById("onSiteTab").style.display = "none";
}

function showOnSiteTab() {
  document.getElementById("scanTab").style.display = "none";
  document.getElementById("onSiteTab").style.display = "flex";
  refreshOnSiteList();
}

document.getElementById("scanTabBtn").onclick = showScanTab;
document.getElementById("onSiteTabBtn").onclick = showOnSiteTab;

document.getElementById("scanBtn").onclick = async () => {
  const video = document.getElementById("cameraVideo");
  const container = document.getElementById("cameraContainer");
  container.style.display = "block";
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = stream;

  const cancelBtn = document.getElementById("cancelCamera");
  cancelBtn.onclick = () => {
    stream.getTracks().forEach(track => track.stop());
    container.style.display = "none";
  };

  // QR scanning logic here (you already have working code)
  // After scanning, send POST to script like:
  // sendCheckin(driverName, truckInfo);
};

document.getElementById("manualBtn").onclick = () => {
  const driver = prompt("Enter Driver Name:");
  if(!driver) return;
  const truck = prompt("Enter Truck Info (optional):","") || "";
  sendCheckin(driver, truck);
};

function sendCheckin(driver, truck){
  fetch(SCRIPT_URL, {
    method:"POST",
    body: JSON.stringify({ site: currentSite, action: "checkin", driver, truck }),
    headers: { "Content-Type": "application/json" }
  })
  .then(()=>{ alert("Check-in recorded"); refreshOnSiteList(); });
}

function sendCheckout(driver){
  fetch(SCRIPT_URL, {
    method:"POST",
    body: JSON.stringify({ site: currentSite, action: "checkout", driver }),
    headers: { "Content-Type": "application/json" }
  })
  .then(()=>{ alert("Sign-out recorded"); refreshOnSiteList(); });
}

function refreshOnSiteList(){
  fetch(`${SCRIPT_URL}?site=${currentSite}`)
  .then(r=>r.json())
  .then(data=>{
    const container = document.getElementById("onSiteList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    container.innerHTML = "";
    data.filter(item => item.name.toLowerCase().includes(search) || item.truck.toLowerCase().includes(search))
        .forEach(item=>{
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<strong>${item.name}</strong><br>${item.truck}<br>${new Date(item.timeIn).toLocaleString()}<br>`;
      const btn = document.createElement("button");
      btn.className = "button button-danger";
      btn.innerText = "Sign Out";
      btn.onclick = ()=>{ if(confirm("Sign out "+item.name+"?")) sendCheckout(item.name); };
      card.appendChild(btn);
      container.appendChild(card);
    });
  });
}

document.getElementById("refreshOnSiteBtn").onclick = refreshOnSiteList;
document.getElementById("searchInput").oninput = refreshOnSiteList;
</script>
</body>
</html>
