<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KPS Guard Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{margin:0;font-family:Arial;background:#0f2a44;color:white;}
    .centered{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;gap:12px;}
    input,button{padding:14px;border-radius:8px;border:none;font-size:16px;}
    input{width:260px;}
    button{background:#1e90ff;color:white;width:260px;}
    .hidden{display:none;}
    .tabbar{position:fixed;bottom:0;width:100%;display:flex;background:#081c30;}
    .tabbar button{flex:1;background:none;border:none;color:white;padding:14px;font-size:16px;}
    .content{padding:20px;padding-bottom:80px;}
    .big-btn{width:100%;font-size:20px;padding:20px;margin-top:20px;}
    .manual-btn{background:#4fa3ff;margin-top:10px;}
    .card{background:#163a5f;padding:14px;border-radius:10px;margin-bottom:10px;}
    .signout-btn{background:#cc3333;margin-top:10px;}
    .popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;}
    .popup-content{background:#163a5f;padding:20px;border-radius:12px;width:90%;max-width:320px;display:flex;flex-direction:column;gap:10px;}
    .search{width:100%;margin-bottom:10px;}
  </style>
</head>

<body>


<div id="login" class="centered">
  <h2>KPS Guard Access</h2>
  <input id="passcode" type="password" placeholder="Enter passcode">
  <button id="loginBtn">Enter</button>
</div>

<div id="sites" class="centered hidden">
  <h2>Select Site</h2>
  <button data-site="Site A">Site A</button>
  <button data-site="Site B">Site B</button>
  <button data-site="Site C">Site C</button>
</div>

<div id="app" class="hidden">
  <div class="content">
    <div id="scanTab">
      <button class="big-btn" id="scanBtn">üì∑ Scan</button>
      <button class="big-btn manual-btn" id="manualBtn">‚úèÔ∏è Manual Entry</button>
      <div id="scanner" class="hidden"></div>
    </div>

    <div id="onSiteTab" class="hidden">
      <input class="search" id="search" placeholder="Search name or truck...">
      <button id="refreshBtn">üîÑ Refresh</button>
      <div id="onSiteList"></div>
    </div>
  </div>

  <div class="tabbar">
    <button data-tab="scan">Scan</button>
    <button data-tab="onsite">On Site</button>
  </div>
</div>

<div id="manualPopup" class="popup hidden">
  <div class="popup-content">
    <input id="manualName" placeholder="Driver Name">
    <input id="manualTruck" placeholder="Truck Info">
    <input id="manualTime" type="datetime-local">
    <button id="manualSubmit">Check In</button>
    <button id="manualCancel">Cancel</button>
  </div>
</div>

<div id="confirmPopup" class="popup hidden">
  <div class="popup-content">
    <p>Sign this person out?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">Cancel</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const PASSCODE = "KpsGuard15857!";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby52PhybpixBnv3wjCCjG1wuWr9E_ziMdYQs9zeSRuzoMp9J5LrFdi9IRWcEoGLYm3Z/exec";

  let site = "";
  let currentSignOutId = null;
  let onSiteData = [];

  const el = id => document.getElementById(id);

  const screens = ["login","sites","app","manualPopup","confirmPopup","scanTab","onSiteTab"];

  // Force clean initial UI state
  screens.forEach(id => el(id)?.classList.add("hidden"));
  el("login").classList.remove("hidden");

  function api(p) {
    return fetch(SCRIPT_URL + "?" + new URLSearchParams(p)).then(r => r.json());
  }

  el("loginBtn").onclick = () => {
    if (el("passcode").value === PASSCODE) {
      el("login").classList.add("hidden");
      el("sites").classList.remove("hidden");
    } else alert("Wrong passcode");
  };

  document.querySelectorAll("#sites button").forEach(b => {
    b.onclick = () => {
      site = b.dataset.site;
      el("sites").classList.add("hidden");
      el("app").classList.remove("hidden");
      showTab("scan");
    };
  });

  document.querySelectorAll(".tabbar button").forEach(b => {
    b.onclick = () => showTab(b.dataset.tab);
  });

  function showTab(tab) {
    el("scanTab").classList.toggle("hidden", tab !== "scan");
    el("onSiteTab").classList.toggle("hidden", tab !== "onsite");
    if (tab === "onsite") loadOnSite();
  }

  el("manualBtn").onclick = () => {
    el("manualTime").value = new Date().toISOString().slice(0,16);
    el("manualPopup").classList.remove("hidden");
  };

  el("manualCancel").onclick = () => el("manualPopup").classList.add("hidden");

  el("manualSubmit").onclick = () => {
    api({
      action:"checkin",
      site,
      name:el("manualName").value,
      truck:el("manualTruck").value,
      time:el("manualTime").value
    });
    el("manualPopup").classList.add("hidden");
  };

  el("scanBtn").onclick = () => {
    const scanner = new Html5Qrcode("scanner");
    el("scanner").classList.remove("hidden");
    scanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, text => {
      const [n,t] = text.split("|");
      api({action:"checkin", site, name:n||"", truck:t||"", time:new Date().toISOString()});
      scanner.stop();
      el("scanner").classList.add("hidden");
    });
  };

  function loadOnSite() {
    api({action:"onsite", site}).then(d => {
      onSiteData = d;
      renderOnSite();
    });
  }

  el("refreshBtn").onclick = loadOnSite;
  el("search").oninput = renderOnSite;

  function renderOnSite() {
    const q = el("search").value.toLowerCase();
    el("onSiteList").innerHTML = "";
    onSiteData.filter(p => (p.name+p.truck).toLowerCase().includes(q)).forEach(p => {
      const d = document.createElement("div");
      d.className = "card";
      d.innerHTML = `<b>${p.name}</b><br>${p.truck}<br>${p.time}
        <button class="signout-btn">Sign Out</button>`;
      d.querySelector("button").onclick = () => {
        currentSignOutId = p.id;
        el("confirmPopup").classList.remove("hidden");
      };
      el("onSiteList").appendChild(d);
    });
  }

  el("confirmYes").onclick = () => {
    api({action:"signout", site, id:currentSignOutId}).then(loadOnSite);
    el("confirmPopup").classList.add("hidden");
  };

  el("confirmNo").onclick = () => el("confirmPopup").classList.add("hidden");

});
</script>

</html>
